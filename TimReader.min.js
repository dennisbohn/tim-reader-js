/**
 * TimReader 1.0
 * Creates canvas from a TIM-File
 * 
 * Copyright 2023, Dennis Bohn
 * bohn.media
 * https://www.bohnmedia.de/
 * 
 * Licensed under MIT
 * 
 * Released on: December 12, 2023
 */

class TimReader{_read(t=32){let a=Math.floor(this._pointer/32),i=this._pointer%32,s=this._uint32Array[a]>>i&((1<<t)-1||4294967295);return this._pointer+=t,s}_skip(t){this._pointer+=t}_rewind(){this._pointer=0}_parse(){switch(this._rewind(),this._data={},this._data.tag=this._read(8),this._data.version=this._read(8),this._skip(16),this._data.bpp=this._read(2),this._data.clp=this._read(2),this._skip(28),this._data.clp&&(this._data.clutLength=this._read(32),this._data.clutX=this._read(16),this._data.clutY=this._read(16),this._data.clutWidth=this._read(16),this._data.clutHeight=this._read(16),this._data.clutColors=this._readColors(this._data.clutWidth*this._data.clutHeight,2)),this._data.imageLength=this._read(32),this._data.imageX=this._read(16),this._data.imageY=this._read(16),this._data.imageWidth=this._read(16),this._data.imageHeight=this._read(16),this._data.bpp){case 0:this._data.imageWidth*=4;break;case 1:this._data.imageWidth*=2;break;case 3:this._data.imageWidth/=1.5}this._data.imageColors=this._readColors(this._data.imageWidth*this._data.imageWidth,this._data.bpp)}_readColors(t,a){let i=[];for(let s=0;s<t;s++)switch(a){case 0:i.push(this._data.clutColors[this._read(4)]);break;case 1:i.push(this._data.clutColors[this._read(8)]);break;case 2:i.push({r:Math.round(this._read(5)/31*255),g:Math.round(this._read(5)/31*255),b:Math.round(this._read(5)/31*255),stp:this._read(1)});break;case 3:i.push({r:this._read(8),g:this._read(8),b:this._read(8)})}return i}createCanvas(){let t=this._data,a=document.createElement("canvas");a.width=t.imageWidth,a.height=t.imageHeight;let i=a.getContext("2d"),s=i.getImageData(0,0,a.width,a.height);for(let e=0;e<t.imageColors.length;e++)["r","g","b"].forEach((a,i)=>{s.data[i+4*e]=t.imageColors[e][a]}),s.data[3+4*e]=255;return i.putImageData(s,0,0),a}readArrayBuffer(t){this._uint32Array=new Uint32Array(t),this._parse()}}