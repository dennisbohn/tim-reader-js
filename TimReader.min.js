/**
 * TimReader 1.0
 * Creates canvas from a TIM-File
 * 
 * Copyright 2023, Dennis Bohn
 * bohn.media
 * https://www.bohnmedia.de/
 * 
 * Licensed under MIT
 * 
 * Released on: December 12, 2023
 */

class TimReader{constructor(){this._images=[]}createCanvas(e=0){let t=this._images[e],i=document.createElement("canvas");i.width=t.imageWidth,i.height=t.imageHeight;let a=i.getContext("2d"),r=a.getImageData(0,0,i.width,i.height);for(let s=0;s<t.imageColors.length;s++)["r","g","b"].forEach((e,i)=>{r.data[i+4*s]=t.imageColors[s][e]}),r.data[3+4*s]=255;return a.putImageData(r,0,0),i}readArrayBuffer(e){this._uint32Array=new Uint32Array(e),this._parse()}get length(){return this._images.length}_read(e=32){let t=Math.floor(this._pointer/32),i=this._pointer%32,a=this._uint32Array[t]>>i&((1<<e)-1||4294967295);return this._pointer+=e,a}_skip(e){this._pointer+=e}_rewind(){this._pointer=0}_parse(){for(this._rewind(),this._images.splice(0,this._images.length);16===this._read(8);){let e={};switch(e.version=this._read(8),this._skip(16),e.bpp=this._read(2),e.clp=this._read(2),this._skip(28),e.clp&&(e.clutLength=this._read(32),e.clutX=this._read(16),e.clutY=this._read(16),e.clutWidth=this._read(16),e.clutHeight=this._read(16),e.clutColors=this._readColors(e.clutWidth*e.clutHeight,TimReader.BPP_16_BIT)),e.imageLength=this._read(32),e.imageX=this._read(16),e.imageY=this._read(16),e.imageWidth=this._read(16),e.imageHeight=this._read(16),e.bpp){case TimReader.BPP_4_BIT:e.imageWidth*=4;break;case TimReader.BPP_8_BIT:e.imageWidth*=2;break;case TimReader.BPP_24_BIT:e.imageWidth/=1.5}e.imageColors=this._readColors(e.imageWidth*e.imageWidth,e.bpp,e.clutColors),this._images.push(e)}}_readColors(e,t,i){let a=[];for(let r=0;r<e;r++)switch(t){case TimReader.BPP_4_BIT:a.push(i[this._read(4)]);break;case TimReader.BPP_8_BIT:a.push(i[this._read(8)]);break;case TimReader.BPP_16_BIT:a.push({r:Math.round(this._read(5)/31*255),g:Math.round(this._read(5)/31*255),b:Math.round(this._read(5)/31*255),stp:this._read(1)});break;case TimReader.BPP_24_BIT:a.push({r:this._read(8),g:this._read(8),b:this._read(8)})}return a}}TimReader.BPP_4_BIT=0,TimReader.BPP_8_BIT=1,TimReader.BPP_16_BIT=2,TimReader.BPP_24_BIT=3;