/**
 * TimReader 1.0
 * Creates canvas from a TIM-File
 * 
 * Copyright 2023, Dennis Bohn
 * bohn.media
 * https://www.bohnmedia.de/
 * 
 * Licensed under MIT
 * 
 * Released on: December 12, 2023
 */

class TimReader{constructor(){this._images=[]}createCanvas(e=0){let i=this._images[e],t=document.createElement("canvas");t.width=i.imageWidth,t.height=i.imageHeight;let a=t.getContext("2d"),r=a.getImageData(0,0,t.width,t.height);for(let s=0;s<i.imageColors.length;s++)["r","g","b"].forEach((e,t)=>{r.data[t+4*s]=i.imageColors[s][e]}),r.data[3+4*s]=255;return a.putImageData(r,0,0),t}readArrayBuffer(e){this._uint32Array=new Uint32Array(e),this._parse()}get length(){return this._images.length}_read(e=32){let i=this._pointer>>>5,t=this._pointer%32,a=this._uint32Array[i]>>t&((1<<e)-1||4294967295);return this._pointer+=e,a}_skip(e){this._pointer+=e}_rewind(){this._pointer=0}_parse(){for(this._rewind(),this._images.splice(0,this._images.length);this._read(8)===TimReader.TYPE_TIM;){let e={};switch(e.version=this._read(8),this._skip(16),e.bpp=this._read(2),e.clp=this._read(2),this._skip(28),e.clp&&(e.clutLength=this._read(32),e.clutX=this._read(16),e.clutY=this._read(16),e.clutWidth=this._read(16),e.clutHeight=this._read(16),e.clutColors=this._readColors(e.clutWidth*e.clutHeight,TimReader.BPP_16_BIT)),e.imageLength=this._read(32),e.imageX=this._read(16),e.imageY=this._read(16),e.imageWidth=this._read(16),e.imageHeight=this._read(16),e.bpp){case TimReader.BPP_4_BIT:e.imageWidth*=4;break;case TimReader.BPP_8_BIT:e.imageWidth*=2;break;case TimReader.BPP_24_BIT:e.imageWidth/=1.5}e.imageColors=this._readColors(e.imageWidth*e.imageWidth,e.bpp,e.clutColors),this._images.push(e)}}_readColors(e,i,t){let a=[];for(let r=0;r<e;r++)switch(i){case TimReader.BPP_4_BIT:a.push(t[this._read(4)]);break;case TimReader.BPP_8_BIT:a.push(t[this._read(8)]);break;case TimReader.BPP_16_BIT:a.push({r:527*this._read(5)+23>>6,g:527*this._read(5)+23>>6,b:527*this._read(5)+23>>6,stp:this._read(1)});break;case TimReader.BPP_24_BIT:a.push({r:this._read(8),g:this._read(8),b:this._read(8)})}return a}}TimReader.TYPE_TIM=16,TimReader.BPP_4_BIT=0,TimReader.BPP_8_BIT=1,TimReader.BPP_16_BIT=2,TimReader.BPP_24_BIT=3;