/**
 * TimReader 1.0
 * Creates canvas from a TIM-File
 * 
 * Copyright 2023, Dennis Bohn
 * bohn.media
 * https://www.bohnmedia.de/
 * 
 * Licensed under MIT
 * 
 * Released on: December 12, 2023
 */

class TimReader{constructor(){this._images=[]}createCanvas(e=0){let t=this._images[e],i=document.createElement("canvas");i.width=t.imageWidth,i.height=t.imageHeight;let a=i.getContext("2d"),s=a.getImageData(0,0,i.width,i.height);for(let r=0;r<t.imageColors.length;r++)["r","g","b"].forEach((e,i)=>{s.data[i+4*r]=t.imageColors[r][e]}),s.data[3+4*r]=255;return a.putImageData(s,0,0),i}readArrayBuffer(e){this._uint32Array=new Uint32Array(e),this._parse()}get length(){return this._images.length}_read(e=32){let t=Math.floor(this._pointer/32),i=this._pointer%32,a=this._uint32Array[t]>>i&((1<<e)-1||4294967295);return this._pointer+=e,a}_skip(e){this._pointer+=e}_rewind(){this._pointer=0}_parse(){for(this._rewind(),this._images.splice(0,this._images.length);16===this._read(8);){let e={};switch(e.version=this._read(8),this._skip(16),e.bpp=this._read(2),e.clp=this._read(2),this._skip(28),e.clp&&(e.clutLength=this._read(32),e.clutX=this._read(16),e.clutY=this._read(16),e.clutWidth=this._read(16),e.clutHeight=this._read(16),e.clutColors=this._readColors(e.clutWidth*e.clutHeight,2)),e.imageLength=this._read(32),e.imageX=this._read(16),e.imageY=this._read(16),e.imageWidth=this._read(16),e.imageHeight=this._read(16),e.bpp){case 0:e.imageWidth*=4;break;case 1:e.imageWidth*=2;break;case 3:e.imageWidth/=1.5}e.imageColors=this._readColors(e.imageWidth*e.imageWidth,e.bpp,e.clutColors),this._images.push(e)}}_readColors(e,t,i){let a=[];for(let s=0;s<e;s++)switch(t){case 0:a.push(i[this._read(4)]);break;case 1:a.push(i[this._read(8)]);break;case 2:a.push({r:Math.round(this._read(5)/31*255),g:Math.round(this._read(5)/31*255),b:Math.round(this._read(5)/31*255),stp:this._read(1)});break;case 3:a.push({r:this._read(8),g:this._read(8),b:this._read(8)})}return a}}